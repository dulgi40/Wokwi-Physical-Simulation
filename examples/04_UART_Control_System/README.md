# 📑 04_UART_Control_System

## 📌 要約
UART通信の理解および実習のため、各種入力を受け付けるUARTシステムを構成し、
入力に応じた動作を実装した。

---

## 🚀 1. 背景と目的

組込みシステムでは、UART、SPI、I2Cなどの通信プロトコルを主に使用する。

UARTは非同期式のシリアル通信方式であり、RX/TXラインを通じてデータフレーム単位で通信を行う。
主に以下の用途で使用される。

- デバッグログ出力
- PCとの設定値変更
- 工場出荷時のパラメータ設定
- 外部機器との単純なコマンド通信

本実習では、UARTを用いて外部からのコマンド入力によりシステム状態およびPWM出力を制御する構成を実装した。

本実習の目的は以下の通りである。

- 産業制御のイメージを出すため、前の例と同様にFSM構造を採用する。
- PWMで制御されるLEDピンは、duty 10/50/90の入力をUART通信で受け取り、デューティ比に応じた値を適用する。
- 状態はIDLEとRUNの2つのみとする。
- IDLE状態でもデューティ値は変更可能とし、RUNへ遷移した際にその値が即座に反映されるように構成する。
- 解像度は8bit（256段階）とする。

---

## 🔍 2. 課題

UART理論の学習を目的とし、
LEDのデューティ比をUART入力によって制御するシステムを構成した。

UARTでテキスト入力を受け取る際に必要となる文字列処理およびパース処理の実装を行った。

---

## 🛠 3. 解決策と実装

### PWM設計
- 10%、50%、90%の3段階デューティ比によるPWM制御
- 解像度は8bit（256段階）

### FSM構造

### UART入力処理設計
- 行単位入力を実現するため、`\n`を基準にパースを実装
- `\r`文字の除去処理を追加
- バッファオーバーフロー防止のための制限処理を実装

State
- IDLE
- RUN

Event
- DUTY SET
- STATUS
- GO IDLE
- GO RUN
- UNKNOWN COMMAND
- HELP

---

## 📊 4. 状態遷移表

| Current | Event | Next | 備考 |
|----------|---------|-------|------|
| IDLE | GO RUN | RUN | 指定されたデューティ値でLED制御開始（初期値10%） |
| IDLE | GO IDLE | 変化なし | Already IDLEメッセージ出力 |
| IDLE | DUTY SET | 変化なし | デューティ値のみ変更（LED制御には影響なし） |
| RUN | GO IDLE | IDLE | LED消灯 |
| RUN | GO RUN | 変化なし | Already RUNメッセージ出力 |
| RUN | DUTY SET | 変化なし | デューティ値変更、LED制御にも反映 |
| RUN/IDLE | STATUS | 変化なし | 現在状態を出力 |
| RUN/IDLE | HELP | 変化なし | 使用可能なコマンド表示 |
| RUN/IDLE | UNKNOWN COMMAND | 変化なし | 誤入力メッセージ出力 |

---

## ▶️ 5. 動作確認

![04_UART_Control_System](./04_UART_Control_System.gif)

- IDLE: LED OFF / DUTY SET実行時は値のみ変更
- RUN: LED ON / DUTY SET実行時にLED制御へ反映
- STATUS / HELP / UNKNOWN COMMAND: 状態に関係なく実行可能

---

## 💡 6. 考察

1. 産業現場におけるUART通信の利用場面を意識した実装を行うことができた。
2. SPIやI2C通信との比較を通じて、各通信方式の特徴を理解する必要があると感じた。
3. 文字列処理および入力パース処理の基礎を習得することができた。
